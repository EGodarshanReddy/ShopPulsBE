// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int              @id @default(autoincrement())
  phone              String           @unique
  firstName          String?          @map("first_name")
  lastName           String?          @map("last_name")
  email              String?
  zipCode            String?          @map("zip_code")
  favoriteCategories String[]         @map("favorite_categories")
  userType           String           @map("user_type")
  isVerified         Boolean          @default(false) @map("is_verified")
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  
  partnerStores      PartnerStore[]
  visits             Visit[]
  reviews            Review[]
  rewards            Reward[]
  redemptions        Redemption[]
  referralsGiven     Referral[]       @relation("ReferrerRelation")
  notifications      Notification[]

  @@map("users")
}

model PartnerStore {
  id              Int              @id @default(autoincrement())
  userId          Int              @map("user_id")
  name            String
  description     String?
  contactPhone    String           @map("contact_phone")
  location        String
  latitude        String?
  longitude       String?
  categories      String[]
  businessHours   Json?            @map("business_hours")
  priceRating     Int              @default(1) @map("price_rating")
  upiId           String?          @map("upi_id")
  images          String[]
  servicesOffered String[]         @map("services_offered")
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals           Deal[]
  visits          Visit[]
  reviews         Review[]
  redemptions     Redemption[]
  stats           PartnerStat[]

  @@map("partner_stores")
}

model Deal {
  id                 Int            @id @default(autoincrement())
  partnerId          Int            @map("partner_id")
  name               String
  description        String?
  startDate          DateTime       @map("start_date") @db.Date
  endDate            DateTime       @map("end_date") @db.Date
  dealType           String         @map("deal_type")
  discountPercentage Int?           @map("discount_percentage")
  category           String
  images             String[]
  isActive           Boolean        @default(true) @map("is_active")
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  
  partner            PartnerStore   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  visits             Visit[]

  @@map("deals")
}

model Visit {
  id               Int            @id @default(autoincrement())
  userId           Int            @map("user_id")
  partnerId        Int            @map("partner_id")
  visitDate        DateTime       @map("visit_date") @db.Date
  notes            String?
  dealId           Int?           @map("deal_id")
  status           String         @default("scheduled")
  markedAsVisited  Boolean        @default(false) @map("marked_as_visited")
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner          PartnerStore   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  deal             Deal?          @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@map("visits")
}

model Review {
  id          Int            @id @default(autoincrement())
  userId      Int            @map("user_id")
  partnerId   Int            @map("partner_id")
  rating      Int
  comment     String?
  isPublished Boolean        @default(false) @map("is_published")
  createdAt   DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner     PartnerStore   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Reward {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  points      Int
  reason      String
  referenceId Int?     @map("reference_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rewards")
}

model Redemption {
  id             Int            @id @default(autoincrement())
  userId         Int            @map("user_id")
  partnerId      Int            @map("partner_id")
  points         Int
  amount         Int
  proofImageUrl  String?        @map("proof_image_url")
  code           String
  status         String         @default("pending")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner        PartnerStore   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@map("redemptions")
}

model Referral {
  id            Int      @id @default(autoincrement())
  referrerId    Int      @map("referrer_id")
  referredPhone String   @map("referred_phone")
  status        String   @default("pending")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  referrer      User     @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

model Otp {
  id        Int      @id @default(autoincrement())
  phone     String
  otp       String
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("otps")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  title     String
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model PartnerStat {
  id              Int            @id @default(autoincrement())
  partnerId       Int            @map("partner_id")
  date            DateTime       @db.Date
  storeViews      Int            @default(0) @map("store_views")
  dealViews       Int            @default(0) @map("deal_views")
  scheduledVisits Int            @default(0) @map("scheduled_visits")
  actualVisits    Int            @default(0) @map("actual_visits")
  
  partner         PartnerStore   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, date])
  @@map("partner_stats")
}
